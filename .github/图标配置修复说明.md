# 图标配置修复说明

## 发现的问题

在检查构建配置时，发现了以下图标引用问题：

### ❌ 问题 1：macOS 使用了错误的图标格式
- **位置**: GitHub Actions 工作流
- **错误**: DMG 安装包使用了 `icon.ico`（Windows 格式）
- **正确**: 应该使用 `icon.icns`（macOS 格式）

### ❌ 问题 2：缺少 macOS 图标文件
- 项目中没有 `.icns` 文件
- macOS 应用需要这个文件才能正确显示图标

### ⚠️ 问题 3：Wails 配置不完整
- `wails.json` 中没有配置各平台的图标路径
- 可能导致构建时图标不正确

## 已完成的修复

### ✅ 1. 更新了 `wails.json` 配置

添加了完整的平台图标配置：

```json
{
  "windows": {
    "icon": "assets/icons/icon.ico"
  },
  "linux": {
    "icon": "assets/icons/icon.png"
  },
  "darwin": {
    "icon": "assets/icons/icon.icns"
  }
}
```

### ✅ 2. 创建了 macOS 图标生成脚本

**文件**: `packaging/prepare-macos-icon.sh`

**功能**:
- 自动从 `icon.png` 生成 macOS 所需的 `icon.icns` 文件
- 生成所有必需的尺寸（支持 Retina 显示）
- 支持在 macOS 和 Linux 上运行

**使用方法**:
```bash
# 方式 1
./packaging/prepare-macos-icon.sh

# 方式 2
make prepare-macos-icon
```

### ✅ 3. 更新了 GitHub Actions 工作流

在 macOS 构建流程中添加了：
1. **图标准备步骤**: 构建前自动生成 `.icns` 文件
2. **正确的 DMG 图标**: 使用 `.icns` 而不是 `.ico`

修改的文件：
- `.github/workflows/build-macos-only.yml`
- `.github/workflows/build.yml`

### ✅ 4. 更新了 Makefile

添加了新的构建目标：
```makefile
make prepare-macos-icon    # 生成 macOS 图标
```

### ✅ 5. 创建了详细文档

- **图标配置指南**: `.github/ICON_CONFIGURATION.md`（英文）
- **修复摘要**: `.github/ICON_FIX_SUMMARY.md`（英文）
- **本文档**: 中文说明

## 修复后的状态

| 平台 | 图标文件 | 配置状态 | 自动化 |
|------|---------|---------|--------|
| Windows | `icon.ico` | ✅ 已配置 | ✅ 无需额外步骤 |
| macOS | `icon.icns` | ✅ 已修复 | ✅ 自动生成 |
| Linux | `icon-*.png` | ✅ 已配置 | ✅ 自动生成 |

## 图标生成流程

### macOS (.icns)

```
icon.png (源文件)
    ↓
生成多种尺寸
    ↓
16×16, 32×32, 128×128, 256×256, 512×512
(包含 @2x Retina 版本)
    ↓
合并为 .iconset
    ↓
转换为 icon.icns
```

### Linux (.png)

```
icon.ico (源文件)
    ↓
提取并转换
    ↓
生成多种尺寸 PNG
    ↓
icon-16x16.png, icon-32x32.png, ...
```

## 如何验证修复

### 本地验证（如果在 macOS 上）

```bash
# 1. 生成图标
make prepare-macos-icon

# 2. 检查生成的文件
ls -lh assets/icons/icon.icns

# 3. 构建应用
wails build -platform darwin/universal

# 4. 打开应用查看图标
open build/bin/MarkdownDaoNote.app
```

### CI/CD 验证

1. 推送代码到 GitHub
2. 在 Actions 中查看构建日志
3. 检查 "Prepare macOS icon" 步骤是否成功
4. 下载构建产物验证图标

## 注意事项

### 在 Linux 上生成 .icns ✅

~~当前系统是 Ubuntu，没有 macOS 的 `iconutil` 工具。脚本会显示警告。~~

**已修复！** 脚本现在支持在 Linux 上使用 `png2icns` 工具生成 `.icns` 文件。

安装所需工具：
```bash
sudo apt-get install icnsutils imagemagick
```

脚本会自动检测环境：
- **macOS**: 使用 `iconutil` 和 `sips`
- **Linux**: 使用 `png2icns` 和 ImageMagick
- 两种环境都能生成有效的 `.icns` 文件

### 重复图标类型错误（已修复）

如果遇到 `Duplicate icon element` 错误：
```
Duplicate icon element of type 'ic08' detected
```

这个问题已在最新版本中修复。脚本现在会根据使用的工具（iconutil 或 png2icns）智能选择生成策略，避免重复的图标类型。

详见：[图标生成脚本修复说明](图标生成脚本修复.md)

### 更新图标

如果将来需要更新应用图标：

1. 替换 `assets/icons/icon.png`（推荐至少 512×512）
2. 或替换 `assets/icons/icon.ico`
3. 运行生成脚本：
   ```bash
   ./packaging/prepare-icons.sh      # Linux 图标
   ./packaging/prepare-macos-icon.sh # macOS 图标
   ```
4. 重新构建应用

## 技术细节

### 所需工具

| 工具 | macOS | Linux | 用途 |
|------|-------|-------|------|
| `iconutil` | ✅ 系统自带 | ❌ | 生成 .icns |
| `sips` | ✅ 系统自带 | ❌ | 调整图片尺寸 |
| `icnsutils` | 可安装 | ✅ 可安装 | 生成 .icns (替代) |
| ImageMagick | ✅ 可用 | ✅ 可用 | 图片转换 |

### GitHub Actions 环境

- **macOS runner**: 有 `iconutil` 和 `sips`，可以正确生成 `.icns`
- **Linux runner**: 有 `imagemagick` 和 `icnsutils`，可以生成 PNG 和 .icns
- **Windows runner**: 直接使用 `.ico` 文件，无需额外处理

## 总结

✅ **所有问题已修复**

现在各平台的图标配置都是正确的：

- **Windows**: 使用 `icon.ico` ✅
- **macOS**: 使用 `icon.icns`（自动生成）✅
- **Linux**: 使用多尺寸 PNG（自动生成）✅

在 GitHub Actions 中构建时，所有图标都会自动准备和应用，无需手动干预。

## 相关文件

- `wails.json` - Wails 构建配置（已更新）
- `Makefile` - 构建脚本（已添加新目标）
- `packaging/prepare-macos-icon.sh` - macOS 图标生成脚本（新建）
- `.github/workflows/build.yml` - 主构建流程（已更新）
- `.github/workflows/build-macos-only.yml` - macOS 专用构建（已更新）
- `.github/ICON_CONFIGURATION.md` - 详细配置文档
- `.github/ICON_FIX_SUMMARY.md` - 英文修复摘要

