name: Build and Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**.md'
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

# ÊùÉÈôêÈÖçÁΩÆÔºöÂÖÅËÆ∏ÂàõÂª∫ Release
permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Add Go bin to PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Verify Wails installation
        run: |
          which wails
          wails version

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        working-directory: frontend
        run: |
          echo "Building frontend..."
          npm run build
          echo "Frontend build completed!"
          ls -la dist/ || echo "Warning: dist directory not found"

      - name: Prepare macOS icon
        run: |
          chmod +x packaging/prepare-macos-icon.sh
          ./packaging/prepare-macos-icon.sh || echo "‚ö†Ô∏è  Icon preparation failed, continuing..."

      - name: Build application
        run: |
          echo "Building macOS Universal App..."
          wails build -platform darwin/universal -v 2
        env:
          CGO_ENABLED: 1

      - name: Verify build output
        run: |
          echo "Build output:"
          ls -lh build/bin/
          if [ -d "build/bin/MarkdownDaoNote.app" ]; then
            echo "‚úÖ App bundle created successfully"
            file build/bin/MarkdownDaoNote.app/Contents/MacOS/MarkdownDaoNote
          else
            echo "‚ùå App bundle not found"
            exit 1
          fi

      - name: Create DMG installer
        run: |
          # ÂÆâË£Ö create-dmg
          brew install create-dmg
          
          # ÂàõÂª∫ DMGÔºà‰ΩøÁî® .icns ÂõæÊ†áÔºâ
          if [ -f "assets/icons/icon.icns" ]; then
            VOLICON_PARAM="--volicon assets/icons/icon.icns"
          else
            VOLICON_PARAM=""
          fi
          
          create-dmg \
            --volname "MarkdownDaoNote" \
            $VOLICON_PARAM \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "MarkdownDaoNote.app" 175 120 \
            --hide-extension "MarkdownDaoNote.app" \
            --app-drop-link 425 120 \
            --no-internet-enable \
            "build/bin/MarkdownDaoNote-macos-universal.dmg" \
            "build/bin/MarkdownDaoNote.app" || {
              echo "‚ö†Ô∏è  DMG creation failed, but app is still available"
            }

      - name: Create ZIP archive
        run: |
          cd build/bin
          zip -r MarkdownDaoNote-macos-universal.zip MarkdownDaoNote.app
          cd ../..
          echo "‚úÖ ZIP archive created"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MarkdownDaoNote-macos
          path: |
            build/bin/MarkdownDaoNote.app
            build/bin/MarkdownDaoNote-macos-universal.dmg
            build/bin/MarkdownDaoNote-macos-universal.zip
          retention-days: 30

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            pkg-config \
            build-essential \
            imagemagick

      - name: Create webkit2gtk symlink
        run: |
          # Ubuntu 24.04 ‰ΩøÁî® webkit2gtk-4.1Ôºå‰ΩÜ Wails ÊúüÊúõ webkit2gtk-4.0
          sudo ln -sf /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc \
                      /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc
          echo "‚úÖ Created webkit2gtk-4.0 symlink"

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install NFPM
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@latest

      - name: Add Go bin to PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Build application
        run: wails build -v 2

      - name: Prepare icons
        run: |
          chmod +x packaging/prepare-icons.sh
          ./packaging/prepare-icons.sh

      - name: Build DEB package
        run: |
          mkdir -p build/packages
          nfpm package --packager deb --target build/packages/

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MarkdownDaoNote-linux
          path: |
            build/bin/MarkdownDaoNote
            build/packages/*.deb
          retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Add Go bin to PATH
        run: echo "$(go env GOPATH)/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: pwsh

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Build application
        run: |
          echo "Building Windows application..."
          wails build -v 2
        shell: pwsh

      - name: Verify build output
        run: |
          echo "Build output:"
          ls build/bin/
          if (Test-Path "build/bin/MarkdownDaoNote.exe") {
            echo "‚úÖ Executable created successfully"
            (Get-Item "build/bin/MarkdownDaoNote.exe").Length
          } else {
            echo "‚ùå Executable not found"
            exit 1
          }
        shell: pwsh

      - name: Install NSIS
        run: |
          echo "Installing NSIS..."
          choco install nsis -y
        shell: pwsh

      - name: Verify installer assets
        run: |
          echo "Verifying required files for installer..."
          if (Test-Path "assets\icons\icon.ico") {
            echo "‚úÖ icon.ico found"
          } else {
            echo "‚ùå icon.ico not found"
            exit 1
          }
          if (Test-Path "assets\icons\header_image.bmp") {
            echo "‚úÖ header_image.bmp found"
          } else {
            echo "‚ö†Ô∏è  header_image.bmp not found (optional)"
          }
          if (Test-Path "build\bin\MarkdownDaoNote.exe") {
            echo "‚úÖ MarkdownDaoNote.exe found"
          } else {
            echo "‚ùå MarkdownDaoNote.exe not found"
            exit 1
          }
        shell: pwsh

      - name: Create NSIS installer
        run: |
          echo "Creating Windows installer..."
          $projectRoot = (Get-Location).Path
          echo "Project root: $projectRoot"
          
          # ËΩ¨Êç¢Ë∑ØÂæÑ‰∏∫ NSIS Ê†ºÂºèÔºà‰ΩøÁî®ÂèçÊñúÊù†Ôºâ
          $nsisProjectRoot = $projectRoot -replace '/', '\'
          
          # ÊûÑÂª∫ NSIS ÂëΩ‰ª§
          $nsisCmd = "C:\Program Files (x86)\NSIS\makensis.exe"
          $nsisArgs = @(
            "/V4"
            "/DPROJECT_ROOT=$nsisProjectRoot"
            "scripts\installer.nsi"
          )
          
          echo "Running: $nsisCmd $($nsisArgs -join ' ')"
          & $nsisCmd @nsisArgs
          
          if ($LASTEXITCODE -eq 0) {
            echo "‚úÖ Installer created successfully"
            ls build\bin\*.exe
          } else {
            echo "‚ùå Installer creation failed with exit code: $LASTEXITCODE"
            exit $LASTEXITCODE
          }
        shell: pwsh

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MarkdownDaoNote-windows
          path: |
            build/bin/MarkdownDaoNote.exe
            build/bin/MarkdownDaoNote-*-installer.exe
          retention-days: 30

  release:
    name: Create Release
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          
          echo "üì¶ Preparing release assets..."
          echo "Available artifacts:"
          ls -R artifacts/
          echo ""
          
          # macOS - DMG Âíå ZIP
          echo "üçé Processing macOS artifacts..."
          if [ -f "artifacts/MarkdownDaoNote-macos/MarkdownDaoNote-macos-universal.dmg" ]; then
            cp artifacts/MarkdownDaoNote-macos/MarkdownDaoNote-macos-universal.dmg release/
            echo "‚úÖ Copied macOS DMG"
          else
            echo "‚ö†Ô∏è  macOS DMG not found"
          fi
          if [ -f "artifacts/MarkdownDaoNote-macos/MarkdownDaoNote-macos-universal.zip" ]; then
            cp artifacts/MarkdownDaoNote-macos/MarkdownDaoNote-macos-universal.zip release/
            echo "‚úÖ Copied macOS ZIP"
          else
            echo "‚ö†Ô∏è  macOS ZIP not found"
          fi
          
          # Linux - ‰∫åËøõÂà∂Âíå DEB ÂåÖ
          echo ""
          echo "üêß Processing Linux artifacts..."
          # Linux ‰∫åËøõÂà∂Âú® bin/ Â≠êÁõÆÂΩï‰∏≠
          if [ -f "artifacts/MarkdownDaoNote-linux/bin/MarkdownDaoNote" ]; then
            cp artifacts/MarkdownDaoNote-linux/bin/MarkdownDaoNote release/MarkdownDaoNote-linux
            chmod +x release/MarkdownDaoNote-linux
            echo "‚úÖ Copied Linux binary"
          else
            echo "‚ö†Ô∏è  Linux binary not found at artifacts/MarkdownDaoNote-linux/bin/MarkdownDaoNote"
          fi
          
          # ‰ΩøÁî® find Êü•Êâæ DEB ÂåÖÔºàÂú® packages/ Â≠êÁõÆÂΩï‰∏≠Ôºâ
          if [ -d "artifacts/MarkdownDaoNote-linux" ]; then
            deb_count=$(find artifacts/MarkdownDaoNote-linux -name "*.deb" | wc -l)
            if [ "$deb_count" -gt 0 ]; then
              find artifacts/MarkdownDaoNote-linux -name "*.deb" -exec cp {} release/ \;
              echo "‚úÖ Copied $deb_count DEB package(s)"
            else
              echo "‚ö†Ô∏è  No DEB packages found"
            fi
          fi
          
          # Windows - EXE ÂíåÂÆâË£ÖÁ®ãÂ∫è
          echo ""
          echo "ü™ü Processing Windows artifacts..."
          if [ -f "artifacts/MarkdownDaoNote-windows/MarkdownDaoNote.exe" ]; then
            cp artifacts/MarkdownDaoNote-windows/MarkdownDaoNote.exe release/MarkdownDaoNote-windows.exe
            echo "‚úÖ Copied Windows EXE"
          else
            echo "‚ö†Ô∏è  Windows EXE not found"
          fi
          
          installer_count=$(find artifacts/MarkdownDaoNote-windows -name "*-installer.exe" 2>/dev/null | wc -l)
          if [ "$installer_count" -gt 0 ]; then
            find artifacts/MarkdownDaoNote-windows -name "*-installer.exe" -exec cp {} release/ \;
            echo "‚úÖ Copied Windows installer"
          else
            echo "‚ö†Ô∏è  Windows installer not found"
          fi
          
          echo ""
          echo "üìã Final release assets:"
          ls -lh release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

